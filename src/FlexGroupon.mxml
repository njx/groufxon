<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009"
               xmlns:s="library://ns.adobe.com/flex/spark"
               initialize="initializeHandler(event)"
			   applicationDPI="160"
               xmlns:components="components.*"
			   resize="resizeHandler(event)"
			   resizeForSoftKeyboard="false"
			   splashScreenImage="@Embed('assets/floupon-splash-opt.png')"
			   splashScreenScaleMode="zoom">
 	<!-- TODO: splash screen, icon -->
 	<fx:Style source="assets/styles.css"/>
    <fx:Script>
        <![CDATA[           
			import mx.events.ResizeEvent;
			
			import spark.transitions.CrossFadeViewTransition;
			
			import views.DetailView;
 
            // Coordinates
            private const LIST_WIDTH:Number = 400;  // Width of list in Tablet Landscape orientation
            private const LIST_HEIGHT:Number = 250; // Height of list in Tablet Portrait orientation
			private const ACTIONBAR_HEIGHT: Number = 46;

            private function initializeHandler(event:Event):void
            {
				// Add event handlers for the Back button. This is necessary because we're not using ViewNavigatorApplication
				// (which does this automatically)--we're using a plain Spark Application and hooking up our own
				// ViewNavigator.
                systemManager.stage.addEventListener(KeyboardEvent.KEY_DOWN, deviceKeyDownHandler);
                systemManager.stage.addEventListener(KeyboardEvent.KEY_UP, deviceKeyUpHandler);
            }
            
			private function resizeHandler(event:ResizeEvent):void
            {
				updateState(width, height);
			}
			
			private function updateState(newWidth: Number, newHeight: Number): void {
                var isPortrait:Boolean = newHeight > newWidth;
                var isTablet:Boolean = newHeight > 960 || newWidth > 960;
                
               currentState = (isPortrait ? "portrait" : "landscape") + (isTablet ? "Tablet" : "Phone");
            }  
            
            private function deviceKeyDownHandler(event:KeyboardEvent):void
            {
                var key:uint = event.keyCode;
                
                // The default behavior for the back key (when it's not being handled by
				// ViewNavigatorApplication) is to jump out of the app to the OS home screen.
				// In our case, if we have a view to pop back to on the navigator stack, we
				// don't want this default behavior.
                if (key == Keyboard.BACK)
                {
                    if (mainNavigator.length > 1)
                        event.preventDefault();
                }
            }
            
            private function deviceKeyUpHandler(event:KeyboardEvent):void
            {
                var key:uint = event.keyCode;
                
                if (key == Keyboard.BACK && mainNavigator.length > 1)
                    mainNavigator.popView();
            }

		]]>
    </fx:Script>
    <s:states>
        <s:State name="landscapeTablet" stateGroups="landscape, tablet" />
        <s:State name="portraitTablet" stateGroups="portrait, tablet" />
        <s:State name="portraitPhone" stateGroups="portrait, phone" />
        <s:State name="landscapePhone" stateGroups="landscape, phone" />
    </s:states>
	
	<!-- ViewNavigator -->
	<!-- On phones, this fills the whole screen. On tablet, this is on the right (in landscape mode) or on the bottom (in portrait mode).
		 The resize handler here is to work around a bug where ViewNavigator doesn't currently clip its children, so if
		 it doesn't fill the whole screen, views sliding out of the navigator overlap other content. (SDK-29309) -->
	<s:ViewNavigator id="mainNavigator" left="0" left.landscapeTablet="{LIST_WIDTH}" 
					 top="0" top.portraitTablet="{ACTIONBAR_HEIGHT + LIST_HEIGHT}" 
					 right="0" bottom="0"
					 firstView="views.SummaryView" firstView.tablet="views.DetailView"
					 resize="mainNavigator.scrollRect = new Rectangle(0, 0, mainNavigator.width, mainNavigator.height)"/>  
	
	<!-- ActionBar header over the deals list (only used in tablet mode) -->
	<s:ActionBar id="listHeader" includeIn="tablet" top="0" left="0" right.portraitTablet="0" width.landscapeTablet="{LIST_WIDTH}" title="Nearby Deals">
		<s:actionContent>
			<s:Button click="dealSummaryList.refresh()">
				<s:icon>
					<s:MultiDPIBitmapSource
						source160dpi="@Embed('assets/refresh160.png')"
						source240dpi="@Embed('assets/refresh240.png')"
						source320dpi="@Embed('assets/refresh320.png')"/>
				</s:icon>
			</s:Button>
		</s:actionContent>
	</s:ActionBar>

	<!-- Deal summary list -->
	<components:SummaryList id="dealSummaryList" includeIn="tablet" top="{ACTIONBAR_HEIGHT}" left="0" 
							bottom.landscapeTablet="0" right.portraitTablet="0" 
							width.landscapeTablet="{LIST_WIDTH}" height.portraitTablet="{LIST_HEIGHT}"
							change="mainNavigator.replaceView(views.DetailView, dealSummaryList.list.selectedItem, null, new CrossFadeViewTransition())"
							currentState="{currentState == 'portraitTablet' ? 'grid' : (currentState == 'landscapeTablet' ? 'listTablet' : 'listPhone')}"/>
	
	<!-- Vertical separator between summary list and view navigator in tablet landscape mode -->
	<s:Line id="separator" includeIn="landscapeTablet" top="0" bottom="0" left="{LIST_WIDTH}">
		<s:stroke>
			<s:SolidColorStroke color="#666666"/>
		</s:stroke>
	</s:Line>
</s:Application>
